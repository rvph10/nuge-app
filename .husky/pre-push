echo "ğŸš€ Nuge Pre-Push Hook: Running comprehensive checks..."
echo "ğŸ” This ensures your code won't break the CI/CD pipeline"
echo ""

# Get the current branch name
BRANCH=$(git branch --show-current)
echo "ğŸ“Š Current branch: $BRANCH"
echo ""

# Function to check if we should run tests (skip for main/develop to avoid delays)
should_run_full_tests() {
  if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
    return 1  # Don't run full tests for main/develop (they go through PR)
  fi
  return 0
}

# Check if API environment is set up before running lint
check_api_environment() {
  if [ -d "api" ]; then
    cd api
    if [ ! -f "venv/bin/ruff" ] && [ ! -f ".venv/bin/ruff" ] && ! command -v ruff >/dev/null 2>&1; then
      echo "âš ï¸ API Python environment not fully set up"
      echo "ğŸ”§ To fix: cd api && uv sync"
      cd ..
      return 1
    fi
    cd ..
  fi
  return 0
}

# Run quick linting check with environment validation
echo "ğŸ”§ Running quick lint check..."

# Check if API environment is set up
if git diff --name-only HEAD~1 | grep -q "api/"; then
  if ! check_api_environment; then
    echo ""
    echo "âš ï¸ API environment issues detected, skipping API linting"
    echo "ğŸ”§ Please run: cd api && uv sync"
    echo "ğŸ“ Note: CI will catch any issues in the API workspace"
    echo ""
    # Run lint for other workspaces only
    npm run lint:quick --workspace=web --workspace=mobile --workspace=shared
  else
    npm run lint:quick
  fi
else
  npm run lint:quick
fi

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ PUSH BLOCKED: Linting issues found!"
  echo ""
  echo "ğŸ’¡ What happened:"
  echo "   â€¢ ESLint found issues in your changed files"
  echo ""
  echo "ğŸ”§ How to fix:"
  echo "   1. Run: npm run lint -- --fix"
  echo "   2. Fix remaining issues manually"
  echo "   3. Commit the fixes"
  echo "   4. Try pushing again"
  echo ""
  echo "âš¡ To bypass this check (not recommended):"
  echo "   git push --no-verify"
  echo ""
  exit 1
fi

# Run type checking
echo "ğŸ” Running TypeScript type checking..."
npm run type-check

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ PUSH BLOCKED: TypeScript errors found!"
  echo ""
  echo "ğŸ’¡ What happened:"
  echo "   â€¢ TypeScript compilation errors detected"
  echo ""
  echo "ğŸ”§ How to fix:"
  echo "   1. Fix the TypeScript errors shown above"
  echo "   2. Verify with: npm run type-check"
  echo "   3. Commit the fixes"
  echo "   4. Try pushing again"
  echo ""
  echo "âš¡ To bypass this check (not recommended):"
  echo "   git push --no-verify"
  echo ""
  exit 1
fi

# Run build check to ensure everything compiles
echo "ğŸ—ï¸ Running build check to ensure compilation..."
npm run build

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ PUSH BLOCKED: Build failed!"
  echo ""
  echo "ğŸ’¡ What happened:"
  echo "   â€¢ The project failed to build"
  echo "   â€¢ This would cause the CI pipeline to fail"
  echo ""
  echo "ğŸ”§ How to fix:"
  echo "   1. Fix the build errors shown above"
  echo "   2. Test locally with: npm run build"
  echo "   3. Commit the fixes"
  echo "   4. Try pushing again"
  echo ""
  echo "âš¡ To bypass this check (not recommended):"
  echo "   git push --no-verify"
  echo ""
  exit 1
fi

# Run tests for feature branches
if should_run_full_tests; then
  echo "ğŸ§ª Running tests for feature branch..."
  npm run test:quick
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ PUSH BLOCKED: Tests failed!"
    echo ""
    echo "ğŸ’¡ What happened:"
    echo "   â€¢ Some tests are failing"
    echo "   â€¢ This would cause the CI pipeline to fail"
    echo ""
    echo "ğŸ”§ How to fix:"
    echo "   1. Fix the failing tests"
    echo "   2. Run tests locally: npm run test"
    echo "   3. Commit the fixes"
    echo "   4. Try pushing again"
    echo ""
    echo "âš¡ To bypass this check (not recommended):"
    echo "   git push --no-verify"
    echo ""
    exit 1
  fi
else
  echo "â­ï¸ Skipping full tests for $BRANCH (will run in CI)"
fi

# API-specific checks if Python files changed
if git diff --cached --name-only | grep -q "api/.*\.py$"; then
  echo "ğŸ Running Python API checks..."
  
  # Check if we're in the API directory or need to change to it
  if [ -d "api" ]; then
    cd api
    echo "ğŸ”§ Running Python linting and type checking..."
    
    # Run Python linting
    python -m black --check src/ || {
      echo ""
      echo "âŒ PUSH BLOCKED: Python formatting issues!"
      echo "ğŸ”§ Fix with: cd api && python -m black src/"
      echo ""
      exit 1
    }
    
    python -m isort --check-only src/ || {
      echo ""
      echo "âŒ PUSH BLOCKED: Python import sorting issues!"
      echo "ğŸ”§ Fix with: cd api && python -m isort src/"
      echo ""
      exit 1
    }
    
    python -m flake8 src/ || {
      echo ""
      echo "âŒ PUSH BLOCKED: Python linting issues!"
      echo "ğŸ”§ Fix the flake8 issues shown above"
      echo ""
      exit 1
    }
    
    python -m mypy src/ || {
      echo ""
      echo "âŒ PUSH BLOCKED: Python type checking issues!"
      echo "ğŸ”§ Fix the mypy issues shown above"
      echo ""
      exit 1
    }
    
    cd ..
  fi
fi

echo ""
echo "âœ… All pre-push checks passed! ğŸ‰"
echo "ğŸš€ Pushing to remote repository..."
echo "" 